<div class="container mt-4">
  <!-- Afficher un indicateur de chargement -->
  <div *ngIf="loading" class="text-center">
    <div class="spinner-border" role="status">
      <span class="visually-hidden">Chargement...</span>
    </div>
    <p>Vérification de votre rôle...</p>
  </div>

  <!-- Afficher un message d'erreur si nécessaire -->
  <div *ngIf="errorMessage && !loading" class="alert alert-danger">
    {{ errorMessage }}
  </div>

  <!-- Afficher le formulaire uniquement si l'utilisateur est un recruteur et que le chargement est terminé -->
  <form *ngIf="!loading && isRecruiter" [formGroup]="offreForm" (ngSubmit)="onSubmit()" class="container mt-4">
    <div class="form-group">
      <label for="titre">Titre</label>
      <input id="titre" formControlName="titre" type="text" class="form-control" placeholder="Ex: Développeur Full Stack" />
      <div *ngIf="offreForm.get('titre')?.invalid && offreForm.get('titre')?.touched" class="text-danger">
        <div *ngIf="offreForm.get('titre')?.errors?.['required']">Le titre est requis.</div>
        <div *ngIf="offreForm.get('titre')?.errors?.['maxLength']">Le titre ne peut pas dépasser 200 caractères.</div>
      </div>
    </div>

    <div class="form-group">
      <label for="specialite">Spécialité</label>
      <input id="specialite" formControlName="specialite" type="text" class="form-control" placeholder="Ex: Informatique" />
      <div *ngIf="offreForm.get('specialite')?.invalid && offreForm.get('specialite')?.touched" class="text-danger">
        <div *ngIf="offreForm.get('specialite')?.errors?.['required']">La spécialité est requise.</div>
        <div *ngIf="offreForm.get('specialite')?.errors?.['maxLength']">La spécialité ne peut pas dépasser 100 caractères.</div>
      </div>
    </div>

    <div class="form-group">
      <label for="description">Description</label>
      <textarea id="description" formControlName="description" class="form-control" placeholder="Description du poste..."></textarea>
      <div *ngIf="offreForm.get('description')?.invalid && offreForm.get('description')?.touched" class="text-danger">
        <div *ngIf="offreForm.get('description')?.errors?.['required']">La description est requise.</div>
        <div *ngIf="offreForm.get('description')?.errors?.['maxLength']">La description ne peut pas dépasser 2000 caractères.</div>
      </div>
    </div>

    <div class="form-group">
      <label for="diplomeRequis">Diplôme Requis</label>
      <input id="diplomeRequis" formControlName="diplomeRequis" type="text" class="form-control" placeholder="Ex: Licence" />
      <div *ngIf="offreForm.get('diplomeRequis')?.invalid && offreForm.get('diplomeRequis')?.touched" class="text-danger">
        <div *ngIf="offreForm.get('diplomeRequis')?.errors?.['required']">Le diplôme requis est requis.</div>
        <div *ngIf="offreForm.get('diplomeRequis')?.errors?.['maxLength']">Le diplôme requis ne peut pas dépasser 100 caractères.</div>
      </div>
    </div>

    <div class="form-group">
      <label for="niveauExperienceRequis">Niveau d'expérience</label>
      <input id="niveauExperienceRequis" formControlName="niveauExperienceRequis" type="text" class="form-control" placeholder="Ex: 2 ans" />
      <div *ngIf="offreForm.get('niveauExperienceRequis')?.invalid && offreForm.get('niveauExperienceRequis')?.touched" class="text-danger">
        <div *ngIf="offreForm.get('niveauExperienceRequis')?.errors?.['required']">Le niveau d'expérience est requis.</div>
        <div *ngIf="offreForm.get('niveauExperienceRequis')?.errors?.['maxLength']">Le niveau d'expérience ne peut pas dépasser 50 caractères.</div>
      </div>
    </div>

    <div class="form-group">
      <label for="salaire">Salaire</label>
      <input id="salaire" formControlName="salaire" type="number" class="form-control" placeholder="Ex: 50000" />
      <div *ngIf="offreForm.get('salaire')?.invalid && offreForm.get('salaire')?.touched" class="text-danger">
        <div *ngIf="offreForm.get('salaire')?.errors?.['required']">Le salaire est requis.</div>
        <div *ngIf="offreForm.get('salaire')?.errors?.['min']">Le salaire doit être positif.</div>
      </div>
    </div>

    <div class="form-group">
      <label for="datePublication">Date de publication</label>
      <input id="datePublication" formControlName="datePublication" type="date" class="form-control" />
    </div>

    <div class="form-group">
      <label for="dateExpiration">Date d'expiration</label>
      <input id="dateExpiration" formControlName="dateExpiration" type="date" class="form-control" />
    </div>

    <!-- <div class="form-group">
      <label for="dateModification">Date de modification</label>
      <input id="dateModification" formControlName="dateModification" type="date" class="form-control" readonly />
    </div> -->

    <div class="form-group">
      <label for="typeContrat">Type de Contrat</label>
      <select id="typeContrat" formControlName="typeContrat" class="form-control">
        <option [value]="null" disabled selected>Choisir un type</option>
        <option *ngFor="let contrat of typeContrats" [value]="contrat[1]">{{ contrat[0] }}</option>
      </select>
      <div *ngIf="offreForm.get('typeContrat')?.invalid && offreForm.get('typeContrat')?.touched" class="text-danger">
        <div *ngIf="offreForm.get('typeContrat')?.errors?.['required']">Le type de contrat est requis.</div>
      </div>
    </div>

    <div class="form-group">
      <label for="statut">Statut</label>
      <select id="statut" formControlName="statut" class="form-control">
        <option [value]="null" disabled selected>Choisir un statut</option>
        <option *ngFor="let statut of statuts" [value]="statut[1]">{{ statut[0] }}</option>
      </select>
      <div *ngIf="offreForm.get('statut')?.invalid && offreForm.get('statut')?.touched" class="text-danger">
        <div *ngIf="offreForm.get('statut')?.errors?.['required']">Le statut est requis.</div>
      </div>
    </div>

    <div class="form-group">
      <label for="modeTravail">Mode de travail</label>
      <select id="modeTravail" formControlName="modeTravail" class="form-control">
        <option *ngFor="let mode of modesTravail" [value]="mode[1]">{{ mode[0] }}</option>
      </select>
      <div *ngIf="offreForm.get('modeTravail')?.invalid && offreForm.get('modeTravail')?.touched" class="text-danger">
        <div *ngIf="offreForm.get('modeTravail')?.errors?.['required']">Le mode de travail est requis.</div>
      </div>
    </div>

    <div class="form-group">
      <label for="nombrePostes">Nombre de postes</label>
      <input id="nombrePostes" formControlName="nombrePostes" type="number" class="form-control" placeholder="Ex: 1" />
      <div *ngIf="offreForm.get('nombrePostes')?.invalid && offreForm.get('nombrePostes')?.touched" class="text-danger">
        <div *ngIf="offreForm.get('nombrePostes')?.errors?.['required']">Le nombre de postes est requis.</div>
        <div *ngIf="offreForm.get('nombrePostes')?.errors?.['min']">Le nombre de postes doit être au moins 1.</div>
      </div>
    </div>

    <div class="form-group">
      <label for="avantages">Avantages</label>
      <textarea id="avantages" formControlName="avantages" class="form-control" placeholder="Ex: Assurance, télétravail..."></textarea>
    </div>


    <div class="form-group">
      <label for="recruteurNom">Nom du Recruteur</label>
      <input id="recruteurNom" formControlName="recruteurNom" type="text" class="form-control" readonly />
    </div>

    <div class="form-group">
      <label for="idFiliale">Filiale</label>
      <select id="idFiliale" formControlName="idFiliale" class="form-control">
        <option [value]="null" disabled selected>Choisir une filiale</option>
        <option *ngFor="let filiale of filiales" [value]="filiale.idFiliale">{{ filiale.nom }}</option>
      </select>
      <div *ngIf="offreForm.get('idFiliale')?.invalid && offreForm.get('idFiliale')?.touched" class="text-danger">
        <div *ngIf="offreForm.get('idFiliale')?.errors?.['required']">La filiale est requise.</div>
      </div>
    </div>

    <h3>Compétences</h3>
    <div formArrayName="offreCompetences">
      <div *ngFor="let comp of offreCompetences.controls; let i = index" [formGroupName]="i" class="card mb-3">
        <div class="card-body">
          <div class="form-group">
            <label>ID Compétence (optionnel)</label>
            <input formControlName="idCompetence" class="form-control" placeholder="ID compétence" />
          </div>
          <div formGroupName="competence">
            <div class="form-group">
              <label for="nom-{{i}}">Nom</label>
              <input id="nom-{{i}}" formControlName="nom" class="form-control" placeholder="Ex: Angular" />
              <div *ngIf="offreCompetences.at(i).get('competence.nom')?.invalid && offreCompetences.at(i).get('competence.nom')?.touched" class="text-danger">
                <div *ngIf="offreCompetences.at(i).get('competence.nom')?.errors?.['required']">Le nom de la compétence est requis.</div>
              </div>
            </div>
            <div class="form-group">
              <label for="description-{{i}}">Description</label>
              <input id="description-{{i}}" formControlName="description" class="form-control" placeholder="Ex: Maîtrise d'Angular" />
            </div>
            <div class="form-group">
              <label>Hard Skills (max 5)</label>
              <div *ngFor="let skill of hardSkills; let j = index">
                <label>
                  <input type="checkbox" [formControl]="getHardSkillControl(i, j)" />
                  {{ skill }}
                </label>
              </div>
              <div *ngIf="getHardSkillsArray(i).errors?.['maxSelections']" class="text-danger">
                Maximum 5 hard skills autorisés. Actuellement sélectionnés: {{ getHardSkillsArray(i).errors?.['maxSelections'].selected }}
              </div>
            </div>
            <div class="form-group">
              <label>Soft Skills (max 5)</label>
              <div *ngFor="let skill of softSkills; let j = index">
                <label>
                  <input type="checkbox" [formControl]="getSoftSkillControl(i, j)" />
                  {{ skill }}
                </label>
              </div>
              <div *ngIf="getSoftSkillsArray(i).errors?.['maxSelections']" class="text-danger">
                Maximum 5 soft skills autorisés. Actuellement sélectionnés: {{ getSoftSkillsArray(i).errors?.['maxSelections'].selected }}
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="niveauRequis-{{i}}">Niveau requis</label>
            <select id="niveauRequis-{{i}}" formControlName="niveauRequis" class="form-control">
              <option *ngFor="let niveau of niveauxRequis" [value]="niveau">{{ niveau }}</option>
            </select>
            <div *ngIf="offreCompetences.at(i).get('niveauRequis')?.invalid && offreCompetences.at(i).get('niveauRequis')?.touched" class="text-danger">
              <div *ngIf="offreCompetences.at(i).get('niveauRequis')?.errors?.['required']">Le niveau requis est requis.</div>
            </div>
          </div>
          <button type="button" class="btn btn-danger" (click)="removeCompetence(i)">Supprimer</button>
        </div>
      </div>
    </div>
    <button type="button" class="btn btn-primary mb-3" (click)="addCompetence()">Ajouter compétence</button>

    <div class="text-center">
      <button type="submit" class="btn btn-success">{{ isEditMode ? 'Mettre à jour' : 'Créer' }}</button>
    </div>
  </form>
</div>